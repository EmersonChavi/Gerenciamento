<script>
  const STORAGE_KEY = 'gerenciamentoServicosData';
  const ROLE_KEY = 'gerenciamentoServicosRole';
  const KM_START_KEY = 'kmStart';
  const KM_END_KEY = 'kmEnd';

  let state = {
    role: null,
    buildings: [],
    kmStart: null,
    kmEnd: null,
  };

  const loginScreen = document.getElementById('login-screen');
  const mainApp = document.getElementById('main-app');
  const loginManagerBtn = document.getElementById('login-manager');
  const loginWorkerBtn = document.getElementById('login-worker');
  const logoutBtn = document.getElementById('logout-btn');
  const managerControls = document.getElementById('manager-controls');
  const addBuildingForm = document.getElementById('add-building-form');
  const buildingNameInput = document.getElementById('building-name');
  const buildingsList = document.getElementById('buildings-list');

  function loadState() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    const savedRole = localStorage.getItem(ROLE_KEY);
    const savedKmStart = localStorage.getItem(KM_START_KEY);
    const savedKmEnd = localStorage.getItem(KM_END_KEY);

    if (savedData) {
      try {
        state.buildings = JSON.parse(savedData);
      } catch {
        state.buildings = [];
      }
    }
    if (savedRole) state.role = savedRole;
    if (savedKmStart) state.kmStart = parseFloat(savedKmStart);
    if (savedKmEnd) state.kmEnd = parseFloat(savedKmEnd);
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.buildings));
    localStorage.setItem(ROLE_KEY, state.role);
    localStorage.setItem(KM_START_KEY, state.kmStart ?? '');
    localStorage.setItem(KM_END_KEY, state.kmEnd ?? '');
  }

  function render() {
    if (!state.role) {
      loginScreen.classList.remove('hidden');
      mainApp.classList.add('hidden');
      return;
    }
    loginScreen.classList.add('hidden');
    mainApp.classList.remove('hidden');

    managerControls.classList.toggle('hidden', state.role !== 'gerente');
    renderBuildings();
    renderKmInput();
  }

  function renderBuildings() {
    buildingsList.innerHTML = '';

    if (state.buildings.length === 0) {
      buildingsList.innerHTML = '<p class="text-center text-chaviGray">Nenhum prédio cadastrado.</p>';
      return;
    }

    state.buildings.forEach((building, bIndex) => {
      const buildingDiv = document.createElement('div');
      buildingDiv.className = 'bg-white p-8 rounded-lg shadow-lg border border-chaviGray';

      const buildingHeader = document.createElement('div');
      buildingHeader.className = 'flex justify-between items-center mb-6';

      const title = document.createElement('h3');
      title.className = 'text-2xl font-semibold text-chaviBlue';
      title.textContent = building.name;

      buildingHeader.appendChild(title);

      let taskForm;

      if (state.role === 'gerente') {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'text-chaviAccent hover:text-chaviBlue transition flex items-center space-x-2 font-semibold';
        toggleBtn.innerHTML = '<i class="fas fa-plus"></i><span>Adicionar tarefa</span>';
        toggleBtn.addEventListener('click', () => {
          taskForm.classList.toggle('hidden');
        });
        buildingHeader.appendChild(toggleBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-red-600 hover:text-red-800 transition flex items-center space-x-2 font-semibold ml-4';
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i><span>Apagar prédio</span>';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Deseja apagar o prédio "${building.name}"?`)) {
            state.buildings.splice(bIndex, 1);
            saveState();
            render();
          }
        });
        buildingHeader.appendChild(deleteBtn);
      }

      buildingDiv.appendChild(buildingHeader);

      // Formulário de tarefa
      if (state.role === 'gerente') {
        taskForm = document.createElement('form');
        taskForm.className = 'mb-6 hidden';

        const taskInput = document.createElement('input');
        taskInput.type = 'text';
        taskInput.placeholder = 'Descrição da tarefa';
        taskInput.required = true;
        taskInput.className = 'w-full px-4 py-3 border border-chaviGray rounded-lg focus:outline-none focus:ring-2 focus:ring-chaviBlue mb-3';

        const aptInput = document.createElement('input');
        aptInput.type = 'text';
        aptInput.placeholder = 'Número do apartamento';
        aptInput.className = 'w-full px-4 py-3 border border-chaviGray rounded-lg focus:outline-none focus:ring-2 focus:ring-chaviBlue';

        const btnGroup = document.createElement('div');
        btnGroup.className = 'flex justify-end space-x-3 mt-3';

        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.className = 'bg-chaviBlue text-white px-6 py-2 rounded-lg hover:bg-chaviAccent transition';
        submitBtn.textContent = 'Salvar';

        taskForm.appendChild(taskInput);
        taskForm.appendChild(aptInput);
        btnGroup.appendChild(submitBtn);
        taskForm.appendChild(btnGroup);
        buildingDiv.appendChild(taskForm);

        taskForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const desc = taskInput.value.trim();
          const apt = aptInput.value.trim();
          if (!desc) return;
          state.buildings[bIndex].tasks.push({ description: desc, apartment: apt, done: false });
          saveState();
          render();
        });
      }

      // Lista de tarefas
      const taskList = document.createElement('ul');
      taskList.className = 'space-y-3';

      const filteredTasks = building.tasks.filter(t => state.role === 'gerente' || t.done);

      if (filteredTasks.length === 0) {
        const noTask = document.createElement('p');
        noTask.className = 'text-chaviGray italic';
        noTask.textContent = 'Nenhuma tarefa cadastrada.';
        taskList.appendChild(noTask);
      } else {
        filteredTasks.forEach((task, tIndex) => {
          const item = document.createElement('li');
          item.className = 'flex items-center justify-between bg-chaviLightGray p-3 rounded-lg border border-chaviGray';

          const left = document.createElement('div');
          left.className = 'flex items-center space-x-3';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = task.done;
          checkbox.className = 'w-5 h-5 text-chaviBlue rounded';
          checkbox.addEventListener('change', () => {
            task.done = checkbox.checked;
            saveState();
            render();
          });

          const label = document.createElement('span');
          label.textContent = `${task.description}${task.apartment ? ` (Apt ${task.apartment})` : ''}`;
          label.className = task.done ? 'line-through text-gray-400' : 'text-chaviGray';

          left.appendChild(checkbox);
          left.appendChild(label);
          item.appendChild(left);

          if (state.role === 'gerente') {
            const status = document.createElement('span');
            status.className = task.done ? 'text-green-600 font-semibold' : 'text-yellow-600 font-semibold';
            status.textContent = task.done ? 'Concluída' : 'Pendente';
            item.appendChild(status);
          }

          taskList.appendChild(item);
        });
      }

      buildingDiv.appendChild(taskList);
      buildingsList.appendChild(buildingDiv);
    });
  }

  function renderKmInput() {
    const existing = document.getElementById('km-input-div');
    if (existing) existing.remove();

    const kmDiv = document.createElement('div');
    kmDiv.id = 'km-input-div';
    kmDiv.className = 'bg-white p-6 rounded-lg shadow-lg border border-chaviGray mt-8 max-w-md mx-auto';

    if (state.role === 'trabalhador') {
      const startInput = document.createElement('input');
      const endInput = document.createElement('input');
      const result = document.createElement('p');

      function update() {
        const start = parseFloat(startInput.value);
        const end = parseFloat(endInput.value);
        if (!isNaN(start) && !isNaN(end) && end >= start) {
          state.kmStart = start;
          state.kmEnd = end;
          result.textContent = `Você percorreu ${(end - start).toFixed(1)} km.`;
        } else {
          result.textContent = 'Informe valores válidos de KM.';
          state.kmStart = null;
          state.kmEnd = null;
        }
        saveState();
      }

      startInput.type = 'number';
      startInput.value = state.kmStart ?? '';
      startInput.placeholder = 'KM inicial';
      startInput.className = 'w-full mb-3 px-4 py-2 border rounded-lg border-chaviGray';
      startInput.addEventListener('input', update);

      endInput.type = 'number';
      endInput.value = state.kmEnd ?? '';
      endInput.placeholder = 'KM final';
      endInput.className = 'w-full mb-3 px-4 py-2 border rounded-lg border-chaviGray';
      endInput.addEventListener('input', update);

      result.className = 'text-chaviGray font-semibold text-lg mt-2';

      kmDiv.appendChild(startInput);
      kmDiv.appendChild(endInput);
      kmDiv.appendChild(result);
    } else if (state.role === 'gerente') {
      const total = (state.kmStart != null && state.kmEnd != null && state.kmEnd >= state.kmStart)
        ? (state.kmEnd - state.kmStart).toFixed(1)
        : '0.0';
      kmDiv.textContent = `Quilômetros percorridos hoje (moto): ${total} km`;
      kmDiv.className += ' text-center text-chaviGray font-semibold text-lg';
    }

    mainApp.querySelector('main').prepend(kmDiv);
  }

  loginManagerBtn.addEventListener('click', () => {
    state.role = 'gerente';
    saveState();
    render();
  });

  loginWorkerBtn.addEventListener('click', () => {
    state.role = 'trabalhador';
    saveState();
    render();
  });

  logoutBtn.addEventListener('click', () => {
    state.role = null;
    saveState();
    render();
  });

  addBuildingForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = buildingNameInput.value.trim();
    if (!name) return;
    state.buildings.push({ name, tasks: [] });
    buildingNameInput.value = '';
    saveState();
    render();
  });

  loadState();
  render();
</script>
